<div class="analysis-container">
  @if(isTransactionFormVisible) {
    <div class="modal">
      <div class="modal-content">
        <span class="close" (click)="isTransactionFormVisible = false">&times;</span>
        <app-transaction-form
          (transactionAdded)="onTransactionAdded()"
          (closeForm)="isTransactionFormVisible = false">
        </app-transaction-form>
      </div>
    </div>
  }
  <div class="page-header">
    <h1>Financial Analysis</h1>
    <a routerLink="/dashboard" class="back-link">&larr; Back to Dashboard</a>
  </div>

  <div class="tab-switcher">
    <button (click)="selectTab('expenses')" [class.active]="activeTab === 'expenses'">Expenses</button>
    <button (click)="selectTab('income')" [class.active]="activeTab === 'income'">Income</button>
    <button (click)="selectTab('savings')" [class.active]="activeTab === 'savings'">Savings</button>
  </div>

  @if(activeTab === 'expenses') {
    <div class="tab-content">
      <div class="top-section">
        @if(userProfile && expenseSummary) {
          <div class="monthly-progress">
            <h3>Monthly Spend vs Target</h3>
            <div class="progress-bar">
              <div
                class="progress-fill"
                [style.width.%]="(expenseSummary.totalSpendThisMonth / userProfile.targetExpenses) * 100">
              </div>
            </div>
            <div class="progress-labels">
              <span>{{ expenseSummary.totalSpendThisMonth | currency:'INR' }}</span>
              <span>Target: {{ userProfile.targetExpenses | currency:'INR' }}</span>
            </div>
          </div>
        }
        @if(expenseSummary) {
          <div class="overall-summary-container">
            <div class="summary-card"><h4>Total Spend This Month</h4><p>{{ expenseSummary.totalSpendThisMonth | currency:'INR' }}</p></div>
            <div class="summary-card"><h4>Average Daily Spend</h4><p>{{ expenseSummary.averageDailySpend | currency:'INR' }}</p></div>
            <div class="summary-card"><h4>Highest Spending Category</h4><p>{{ expenseSummary.highestSpendingCategory }}</p></div>
          </div>
        }
      </div>

      <div class="content-grid">
        <div class="main-content">
          <div class="chart-box">
            <div class="chart-switcher">
              <button (click)="selectChartType('pie')" [class.active]="selectedChartType === 'pie'">Pie Chart</button>
              <button (click)="selectChartType('bar')" [class.active]="selectedChartType === 'bar'">Bar Chart</button>
            </div>
            @if(selectedChartType === 'pie') {
              <app-pie-chart [data]="expenseByCategory" (categoryClicked)="onCategorySelected($event)"></app-pie-chart>
            }
            @if(selectedChartType === 'bar') {
              <app-bar-chart [data]="expenseByCategory" [label]="'Expenses'" (categoryClicked)="onCategorySelected($event)"></app-bar-chart>
            }
          </div>
        </div>
        <div class="sidebar-content">
          <h2>Category Details</h2>
          @if(selectedExpenseCategorySummary) {
            <div class="summary-card"><h4>Total Spend ({{ selectedExpenseCategorySummary.highestSpendingCategory }})</h4><p>{{ selectedExpenseCategorySummary.totalSpendThisMonth | currency:'INR' }}</p></div>
            <div class="summary-card"><h4>Average Transaction Amount</h4><p>{{ selectedExpenseCategorySummary.averageDailySpend | currency:'INR' }}</p></div>
          } @else {
            <p class="details-prompt">Click a category on a chart for details.</p>
          }
        </div>
      </div>
    </div>
  }

  @if(activeTab === 'income') {
    <div class="tab-content">
      @if(incomeSummary) {
        <div class="overall-summary-container full-width">
          <div class="summary-card"><h4>Total Income This Month</h4><p>{{ incomeSummary.totalIncomeThisMonth | currency:'INR' }}</p></div>
          <div class="summary-card"><h4>Highest Income Source</h4><p>{{ incomeSummary.highestIncomeCategory }}</p></div>
        </div>
      }
      <div class="content-grid">
        <div class="main-content">
          <div class="chart-box">
            <div class="chart-switcher">
              <button (click)="selectChartType('pie')" [class.active]="selectedChartType === 'pie'">Pie Chart</button>
              <button (click)="selectChartType('bar')" [class.active]="selectedChartType === 'bar'">Bar Chart</button>
            </div>
            @if(selectedChartType === 'pie') {
              <app-pie-chart [data]="incomeByCategory" (categoryClicked)="onCategorySelected($event)"></app-pie-chart>
            }
            @if(selectedChartType === 'bar') {
              <app-bar-chart [data]="incomeByCategory" [label]="'Income'" (categoryClicked)="onCategorySelected($event)"></app-bar-chart>
            }
          </div>
        </div>
        <div class="sidebar-content">
          <h2>Category Details</h2>
          @if(selectedIncomeCategorySummary) {
            <div class="summary-card">
              <h4>Total Income ({{ selectedIncomeCategorySummary.highestIncomeCategory }})</h4>
              <p>{{ selectedIncomeCategorySummary.totalIncomeThisMonth | currency:'INR' }}</p>
            </div>
          } @else {
            <p class="details-prompt">Click a category on a chart for details.</p>
          }
        </div>
      </div>
    </div>
  }


  @if(activeTab === 'savings') {
    <div class="tab-content">
      @if(savingsSummary) {
        <div class="overall-summary-container">
          <div class="summary-card"><h4>Total Saved This Month</h4><p>{{ savingsSummary.totalSavedThisMonth | currency:'INR' }}</p></div>
          <div class="summary-card"><h4>Goals in Progress</h4><p>{{ savingsSummary.goalsInProgress }}</p></div>
          <div class="summary-card"><h4>Goals Met</h4><p>{{ savingsSummary.goalsMet }}</p></div>
        </div>
      }
    </div>
  }

  @if(activeTab === 'expenses' || activeTab === 'income') {
    <div class="transaction-section">
      <div class="transactions-header">
        <h3>Full Transaction History</h3>
        <button (click)="onAddTransaction()">Add New Transaction</button>
      </div>
      <app-transactions-list
        [transactions]="transactions"
        (transactionUpdated)="fetchDataForTab()"
        (transactionDeleted)="fetchDataForTab()">
      </app-transactions-list>
    </div>
  }
</div>
